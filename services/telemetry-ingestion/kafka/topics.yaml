# AtlasMesh Kafka Topics Configuration
# Defines all Kafka topics for telemetry ingestion and command distribution

topics:
  # Vehicle Telemetry Topics
  - name: vehicle-telemetry
    partitions: 12
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 604800000  # 7 days
      segment.ms: 86400000     # 1 day
      compression.type: snappy
      max.message.bytes: 1048576  # 1MB
      min.insync.replicas: 2
    description: "High-frequency vehicle telemetry data"
    schema:
      key: "vehicle-id-v1"
      value: "vehicle-telemetry-v1"
    
  - name: vehicle-telemetry-aggregated
    partitions: 6
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: lz4
      max.message.bytes: 2097152  # 2MB
      min.insync.replicas: 2
    description: "Aggregated vehicle telemetry for analytics"
    schema:
      key: "vehicle-id-v1"
      value: "vehicle-telemetry-aggregated-v1"

  # Vehicle Command Topics
  - name: vehicle-commands
    partitions: 8
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: snappy
      max.message.bytes: 524288   # 512KB
      min.insync.replicas: 2
    description: "Commands sent to vehicles"
    schema:
      key: "vehicle-id-v1"
      value: "vehicle-command-v1"

  - name: vehicle-command-responses
    partitions: 8
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: snappy
      max.message.bytes: 524288   # 512KB
      min.insync.replicas: 2
    description: "Command execution responses from vehicles"
    schema:
      key: "command-id-v1"
      value: "command-response-v1"

  # Alert Topics
  - name: vehicle-alerts
    partitions: 4
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 7776000000  # 90 days
      segment.ms: 86400000      # 1 day
      compression.type: snappy
      max.message.bytes: 262144   # 256KB
      min.insync.replicas: 2
    description: "Vehicle alerts and notifications"
    schema:
      key: "vehicle-id-v1"
      value: "vehicle-alert-v1"

  - name: critical-alerts
    partitions: 2
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 31536000000  # 1 year
      segment.ms: 86400000       # 1 day
      compression.type: snappy
      max.message.bytes: 262144    # 256KB
      min.insync.replicas: 2
    description: "Critical alerts requiring immediate attention"
    schema:
      key: "vehicle-id-v1"
      value: "critical-alert-v1"

  # Trip and Route Topics
  - name: trip-events
    partitions: 6
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 7776000000  # 90 days
      segment.ms: 86400000      # 1 day
      compression.type: snappy
      max.message.bytes: 524288   # 512KB
      min.insync.replicas: 2
    description: "Trip lifecycle events"
    schema:
      key: "trip-id-v1"
      value: "trip-event-v1"

  - name: route-updates
    partitions: 4
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: snappy
      max.message.bytes: 1048576  # 1MB
      min.insync.replicas: 2
    description: "Dynamic route updates and optimizations"
    schema:
      key: "route-id-v1"
      value: "route-update-v1"

  # System and Infrastructure Topics
  - name: system-metrics
    partitions: 4
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: lz4
      max.message.bytes: 262144   # 256KB
      min.insync.replicas: 2
    description: "System performance and health metrics"
    schema:
      key: "system-id-v1"
      value: "system-metrics-v1"

  - name: audit-logs
    partitions: 3
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 31536000000  # 1 year
      segment.ms: 86400000       # 1 day
      compression.type: gzip
      max.message.bytes: 524288    # 512KB
      min.insync.replicas: 2
    description: "Audit trail for compliance and security"
    schema:
      key: "audit-id-v1"
      value: "audit-event-v1"

  # Dead Letter Queue Topics
  - name: dead-letter-queue
    partitions: 2
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 7776000000  # 90 days
      segment.ms: 86400000      # 1 day
      compression.type: gzip
      max.message.bytes: 2097152  # 2MB
      min.insync.replicas: 2
    description: "Failed messages for investigation and replay"
    schema:
      key: "error-id-v1"
      value: "dlq-message-v1"

  - name: schema-validation-errors
    partitions: 1
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: gzip
      max.message.bytes: 1048576  # 1MB
      min.insync.replicas: 2
    description: "Schema validation failures"
    schema:
      key: "error-id-v1"
      value: "validation-error-v1"

  # Analytics and ML Topics
  - name: ml-features
    partitions: 4
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 7776000000  # 90 days
      segment.ms: 86400000      # 1 day
      compression.type: lz4
      max.message.bytes: 1048576  # 1MB
      min.insync.replicas: 2
    description: "Feature vectors for machine learning"
    schema:
      key: "feature-id-v1"
      value: "ml-features-v1"

  - name: predictions
    partitions: 2
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 2592000000  # 30 days
      segment.ms: 86400000      # 1 day
      compression.type: snappy
      max.message.bytes: 262144   # 256KB
      min.insync.replicas: 2
    description: "ML model predictions and recommendations"
    schema:
      key: "prediction-id-v1"
      value: "prediction-v1"

  # Real-time Streaming Topics (for WebSocket feeds)
  - name: realtime-telemetry
    partitions: 8
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 3600000     # 1 hour (short retention for real-time)
      segment.ms: 300000        # 5 minutes
      compression.type: snappy
      max.message.bytes: 524288   # 512KB
      min.insync.replicas: 2
    description: "Real-time telemetry for dashboard streaming"
    schema:
      key: "vehicle-id-v1"
      value: "realtime-telemetry-v1"

  - name: realtime-alerts
    partitions: 4
    replication_factor: 3
    config:
      cleanup.policy: delete
      retention.ms: 7200000     # 2 hours
      segment.ms: 600000        # 10 minutes
      compression.type: snappy
      max.message.bytes: 262144   # 256KB
      min.insync.replicas: 2
    description: "Real-time alerts for immediate notification"
    schema:
      key: "alert-id-v1"
      value: "realtime-alert-v1"

# Consumer Groups Configuration
consumer_groups:
  - name: telemetry-ingestion-service
    topics:
      - vehicle-telemetry
      - vehicle-alerts
      - trip-events
    config:
      auto.offset.reset: earliest
      enable.auto.commit: false
      max.poll.records: 1000
      session.timeout.ms: 30000
      heartbeat.interval.ms: 3000
      max.poll.interval.ms: 300000

  - name: analytics-processor
    topics:
      - vehicle-telemetry-aggregated
      - ml-features
      - system-metrics
    config:
      auto.offset.reset: earliest
      enable.auto.commit: true
      max.poll.records: 500
      session.timeout.ms: 30000

  - name: command-processor
    topics:
      - vehicle-commands
      - vehicle-command-responses
    config:
      auto.offset.reset: latest
      enable.auto.commit: false
      max.poll.records: 100
      session.timeout.ms: 10000
      heartbeat.interval.ms: 3000

  - name: alert-processor
    topics:
      - vehicle-alerts
      - critical-alerts
      - realtime-alerts
    config:
      auto.offset.reset: latest
      enable.auto.commit: false
      max.poll.records: 50
      session.timeout.ms: 10000

  - name: realtime-dashboard
    topics:
      - realtime-telemetry
      - realtime-alerts
    config:
      auto.offset.reset: latest
      enable.auto.commit: true
      max.poll.records: 100
      session.timeout.ms: 10000

  - name: audit-processor
    topics:
      - audit-logs
      - dead-letter-queue
    config:
      auto.offset.reset: earliest
      enable.auto.commit: true
      max.poll.records: 100
      session.timeout.ms: 30000

# Topic Monitoring and Alerting
monitoring:
  lag_threshold: 10000  # Alert if consumer lag exceeds this
  throughput_threshold: 1000  # Messages per second
  error_rate_threshold: 0.01  # 1% error rate
  disk_usage_threshold: 0.8   # 80% disk usage

# Data Lifecycle Management
lifecycle:
  # Archive old data to cold storage
  archive_after_days: 7
  # Delete archived data after
  delete_after_days: 365
  # Compact segments older than
  compact_after_hours: 24
