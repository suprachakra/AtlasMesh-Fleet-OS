erDiagram
    title Fleet Core Database - Entity Relationship Diagram

    ORGANIZATIONS {
        uuid organization_id PK
        varchar name
        varchar sector
        jsonb configuration
        jsonb entitlements
        varchar subscription_tier
        varchar primary_contact_name
        varchar primary_contact_email
        varchar primary_contact_phone
        jsonb address
        varchar status
        timestamptz created_at
        timestamptz updated_at
        text[] compliance_frameworks
        jsonb data_residency_requirements
        jsonb metadata
    }

    FLEETS {
        uuid fleet_id PK
        uuid organization_id FK
        varchar name
        text description
        varchar fleet_type
        jsonb configuration
        integer max_vehicles
        varchar status
        timestamptz created_at
        timestamptz updated_at
        varchar created_by
        varchar updated_by
        jsonb operational_hours
        geometry service_area
        jsonb metadata
    }

    VEHICLES {
        uuid vehicle_id PK
        uuid fleet_id FK
        uuid organization_id FK
        varchar asset_tag UK
        varchar vin UK
        varchar license_plate
        varchar manufacturer
        varchar model
        integer year
        jsonb vehicle_profile
        varchar autonomy_level
        varchar operational_status
        varchar autonomy_status
        geometry current_location
        decimal current_heading
        decimal current_speed
        decimal battery_level
        decimal fuel_level
        decimal health_score
        decimal odometer_km
        uuid current_trip_id
        timestamptz last_seen
        timestamptz created_at
        timestamptz updated_at
        varchar created_by
        varchar updated_by
        jsonb maintenance_schedule
        jsonb insurance_info
        jsonb certification_data
        jsonb metadata
    }

    VEHICLE_COMMANDS {
        uuid command_id PK
        uuid vehicle_id FK
        varchar command_type
        jsonb command_payload
        varchar priority
        varchar issued_by
        varchar status
        timestamptz issued_at
        timestamptz sent_at
        timestamptz acknowledged_at
        timestamptz completed_at
        timestamptz expires_at
        jsonb result
        text error_message
        integer retry_count
        uuid correlation_id
        varchar dual_auth_operator
        boolean safety_override
        jsonb metadata
    }

    TRIPS {
        uuid trip_id PK
        uuid vehicle_id FK
        uuid fleet_id FK
        uuid organization_id FK
        varchar trip_type
        varchar status
        geometry origin
        geometry destination
        geometry planned_route
        geometry actual_route
        timestamptz scheduled_start
        timestamptz actual_start
        timestamptz scheduled_end
        timestamptz actual_end
        decimal distance_km
        integer duration_minutes
        integer passenger_count
        decimal cargo_weight_kg
        timestamptz created_at
        timestamptz updated_at
        varchar created_by
        varchar updated_by
        jsonb weather_conditions
        jsonb traffic_conditions
        jsonb incidents
        jsonb cost_breakdown
        decimal customer_rating
        jsonb metadata
    }

    MAINTENANCE_RECORDS {
        uuid maintenance_id PK
        uuid vehicle_id FK
        varchar maintenance_type
        varchar status
        timestamptz scheduled_date
        timestamptz actual_date
        text description
        varchar technician
        varchar location
        decimal odometer_at_service
        decimal cost
        jsonb parts_used
        decimal labor_hours
        decimal next_service_km
        timestamptz next_service_date
        timestamptz created_at
        timestamptz updated_at
        varchar created_by
        jsonb warranty_info
        jsonb compliance_certificates
        jsonb metadata
    }

    INCIDENTS {
        uuid incident_id PK
        uuid vehicle_id FK
        uuid trip_id FK
        varchar incident_type
        varchar severity
        varchar status
        timestamptz occurred_at
        geometry location
        text description
        varchar reported_by
        varchar assigned_to
        timestamptz resolved_at
        text resolution_notes
        timestamptz created_at
        timestamptz updated_at
        jsonb weather_at_incident
        jsonb vehicle_state_at_incident
        jsonb witness_statements
        jsonb media_attachments
        varchar insurance_claim_id
        varchar regulatory_report_id
        jsonb root_cause_analysis
        jsonb corrective_actions
        jsonb metadata
    }

    POLICIES {
        uuid policy_id PK
        uuid organization_id FK
        varchar policy_name UK
        varchar policy_type
        integer version
        text policy_content
        varchar status
        timestamptz created_at
        timestamptz updated_at
        varchar created_by
        varchar updated_by
        timestamptz effective_from
        timestamptz effective_until
        varchar approval_status
        varchar approved_by
        timestamptz approved_at
        text[] tags
        jsonb metadata
    }

    AUDIT_LOGS {
        uuid audit_id PK
        uuid organization_id FK
        varchar event_type
        varchar entity_type
        uuid entity_id
        varchar action
        varchar performed_by
        timestamptz performed_at
        jsonb old_values
        jsonb new_values
        inet ip_address
        text user_agent
        varchar session_id
        uuid correlation_id
        text[] compliance_flags
        timestamptz retention_until
        jsonb metadata
    }

    ORGANIZATIONS ||--o{ FLEETS : owns
    ORGANIZATIONS ||--o{ VEHICLES : owns
    ORGANIZATIONS ||--o{ POLICIES : defines
    ORGANIZATIONS ||--o{ AUDIT_LOGS : generates

    FLEETS ||--o{ VEHICLES : contains
    FLEETS ||--o{ TRIPS : operates

    VEHICLES ||--o{ VEHICLE_COMMANDS : receives
    VEHICLES ||--o{ TRIPS : performs
    VEHICLES ||--o{ MAINTENANCE_RECORDS : undergoes
    VEHICLES ||--o{ INCIDENTS : involved_in

    TRIPS ||--o{ INCIDENTS : may_have
