%%{init: {'flowchart': {'htmlLabels': true}} }%%
graph TB
    %% AtlasMesh Fleet OS - Edge stack ROS2 nodes and topic flows
    %% Version 1.0 | Generated from: ROS2 launch files + ros2 graph | Edge Stack
    %% ROS2 NODE GRAPH: Vehicle Agent edge stack architecture
    %% INTEGRATION CONTRACT: ROS2 Humble with DDS middleware
    %% SAFETY: Safety-critical nodes with redundancy and monitoring
    %% PERFORMANCE: Real-time constraints with QoS policies

    %% Safety Critical Nodes
    subgraph SAFETY["üö® SAFETY CRITICAL NODES"]
        SAFETY_MONITOR[üõ°Ô∏è safety_monitor<br/><b>Safety Monitor Node</b><br/>&bull; Monitors all system health<br/>&bull; Enforces safety constraints<br/>&bull; Triggers emergency stops<br/>&bull; Validates sensor data<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 100 Hz<br/><b>Priority:</b> HIGHEST]
        EMERGENCY_STOP[üõë emergency_stop<br/><b>Emergency Stop Node</b><br/>&bull; Immediate brake activation<br/>&bull; Autonomy system shutdown<br/>&bull; Hazard light control<br/>&bull; Safe state enforcement<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Latency:</b> &lt;10ms<br/><b>Priority:</b> CRITICAL]
        WATCHDOG[üëÅÔ∏è watchdog<br/><b>System Watchdog</b><br/>&bull; Node health monitoring<br/>&bull; Heartbeat validation<br/>&bull; Automatic restart<br/>&bull; Failover coordination<br/><b>QoS:</b> RELIABLE, KEEP_LAST 10<br/><b>Frequency:</b> 10 Hz<br/><b>Priority:</b> HIGH]
    end

    %% Perception Stack
    subgraph PERCEPTION["üîç PERCEPTION STACK"]
        LIDAR[üì° lidar_driver<br/><b>LiDAR Driver</b><br/>&bull; Point cloud generation<br/>&bull; Obstacle detection<br/>&bull; Range measurements<br/>&bull; Calibration management<br/><b>QoS:</b> BEST_EFFORT, KEEP_LAST 3<br/><b>Frequency:</b> 20 Hz<br/><b>Data:</b> PointCloud2]
        CAMERA[üì∑ camera_driver<br/><b>Camera Driver</b><br/>&bull; Image capture<br/>&bull; Lane detection<br/>&bull; Traffic sign recognition<br/>&bull; Object classification<br/><b>QoS:</b> BEST_EFFORT, KEEP_LAST 5<br/><b>Frequency:</b> 30 Hz<br/><b>Data:</b> Image, CompressedImage]
        RADAR[üì∂ radar_driver<br/><b>Radar Driver</b><br/>&bull; Velocity measurements<br/>&bull; Weather-robust detection<br/>&bull; Long-range sensing<br/>&bull; Doppler analysis<br/><b>QoS:</b> RELIABLE, KEEP_LAST 3<br/><b>Frequency:</b> 25 Hz<br/><b>Data:</b> RadarScan]
        SENSOR_FUSION[üîÑ sensor_fusion<br/><b>Sensor Fusion</b><br/>&bull; Multi-sensor integration<br/>&bull; Kalman filtering<br/>&bull; Uncertainty quantification<br/>&bull; Confidence scoring<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 50 Hz<br/><b>Algorithm:</b> Extended Kalman Filter]
        PERCEPTION_PIPELINE[üß† perception_pipeline<br/><b>Perception Pipeline</b><br/>&bull; Object tracking<br/>&bull; Semantic segmentation<br/>&bull; Depth estimation<br/>&bull; Scene understanding<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 20 Hz<br/><b>ML Models:</b> YOLO, SegNet]
    end

    %% Control Stack
    subgraph CONTROL["üéÆ CONTROL STACK"]
        LOCALIZATION[üó∫Ô∏è localization<br/><b>Localization Node</b><br/>&bull; GNSS/IMU fusion<br/>&bull; Map matching<br/>&bull; Pose estimation<br/>&bull; Coordinate transforms<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 100 Hz<br/><b>Accuracy:</b> &lt;10cm]
        PATH_PLANNER[üõ§Ô∏è path_planner<br/><b>Path Planner</b><br/>&bull; Route optimization<br/>&bull; Obstacle avoidance<br/>&bull; Traffic rule compliance<br/>&bull; Dynamic re-planning<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 10 Hz<br/><b>Algorithm:</b> A*, RRT*]
        MOTION_CONTROLLER[üéØ motion_controller<br/><b>Motion Controller</b><br/>&bull; Trajectory following<br/>&bull; Speed regulation<br/>&bull; Steering control<br/>&bull; Brake management<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 100 Hz<br/><b>Control:</b> PID, MPC]
        VEHICLE_INTERFACE[üîå vehicle_interface<br/><b>Vehicle Interface</b><br/>&bull; CAN bus communication<br/>&bull; Actuator commands<br/>&bull; Sensor data collection<br/>&bull; Hardware abstraction<br/><b>QoS:</b> RELIABLE, KEEP_LAST 1<br/><b>Frequency:</b> 1000 Hz<br/><b>Protocol:</b> CAN, Ethernet]
    end

    %% Communication Stack
    subgraph COMMUNICATION["üì° COMMUNICATION STACK"]
        FLEET_GATEWAY[üåê fleet_gateway<br/><b>Fleet Gateway</b><br/>&bull; WebSocket client<br/>&bull; Command processing<br/>&bull; Telemetry transmission<br/>&bull; Status reporting<br/><b>QoS:</b> RELIABLE, KEEP_LAST 10<br/><b>Frequency:</b> 10 Hz<br/><b>Protocol:</b> WebSocket, MQTT]
        V2X_COMM[üìª v2x_communication<br/><b>V2X Communication</b><br/>&bull; Vehicle-to-vehicle V2V<br/>&bull; Vehicle-to-infrastructure V2I<br/>&bull; DSRC/5G connectivity<br/>&bull; Cooperative awareness<br/><b>QoS:</b> BEST_EFFORT, KEEP_LAST 5<br/><b>Frequency:</b> 10 Hz<br/><b>Standard:</b> IEEE 802.11p]
        TELEMETRY_COLLECTOR[üìä telemetry_collector<br/><b>Telemetry Collector</b><br/>&bull; Data aggregation<br/>&bull; Compression<br/>&bull; Buffering<br/>&bull; Transmission scheduling<br/><b>QoS:</b> RELIABLE, KEEP_LAST 100<br/><b>Frequency:</b> 1 Hz<br/><b>Compression:</b> LZ4]
    end

    %% Monitoring Stack
    subgraph MONITORING["üìà MONITORING STACK"]
        DIAGNOSTICS[üîß diagnostics<br/><b>Diagnostics Node</b><br/>&bull; System health monitoring<br/>&bull; Performance metrics<br/>&bull; Error detection<br/>&bull; Log aggregation<br/><b>QoS:</b> RELIABLE, KEEP_LAST 50<br/><b>Frequency:</b> 1 Hz<br/><b>Metrics:</b> CPU, Memory, Network]
        DATA_RECORDER[üíæ data_recorder<br/><b>Data Recorder</b><br/>&bull; ROS bag recording<br/>&bull; Selective logging<br/>&bull; Compression<br/>&bull; Storage management<br/><b>QoS:</b> BEST_EFFORT, KEEP_LAST 1<br/><b>Storage:</b> 500GB SSD<br/><b>Retention:</b> 7 days]
    end

    %% ROS2 Topic Flows (Safety Critical)
    SAFETY_MONITOR -->|/emergency_stop<br/>&#123;trigger, reason&#125;| EMERGENCY_STOP
    WATCHDOG -->|/node_health<br/>&#123;status, heartbeat&#125;| SAFETY_MONITOR
    EMERGENCY_STOP -->|/brake_command<br/>&#123;force, immediate&#125;| VEHICLE_INTERFACE

    %% Perception Topic Flows
    LIDAR -->|/lidar/points<br/>PointCloud2| SENSOR_FUSION
    CAMERA -->|/camera/image<br/>Image| SENSOR_FUSION
    RADAR -->|/radar/scan<br/>RadarScan| SENSOR_FUSION
    SENSOR_FUSION -->|/fused_objects<br/>ObjectArray| PERCEPTION_PIPELINE
    PERCEPTION_PIPELINE -->|/detected_objects<br/>ObjectArray| PATH_PLANNER

    %% Control Topic Flows
    LOCALIZATION -->|/current_pose<br/>PoseWithCovariance| PATH_PLANNER
    PATH_PLANNER -->|/planned_path<br/>Path| MOTION_CONTROLLER
    MOTION_CONTROLLER -->|/control_commands<br/>Twist| VEHICLE_INTERFACE
    VEHICLE_INTERFACE -->|/vehicle_state<br/>Odometry| LOCALIZATION

    %% Communication Topic Flows
    FLEET_GATEWAY -->|/fleet_commands<br/>VehicleCommand| MOTION_CONTROLLER
    TELEMETRY_COLLECTOR -->|/vehicle_telemetry<br/>TelemetryMsg| FLEET_GATEWAY
    V2X_COMM -->|/v2x_objects<br/>ObjectArray| PERCEPTION_PIPELINE

    %% Monitoring Topic Flows
    DIAGNOSTICS -->|/diagnostics<br/>DiagnosticArray| TELEMETRY_COLLECTOR
    DATA_RECORDER -->|/rosbag_status<br/>BagStatus| DATA_RECORDER

    %% Cross-cutting Topic Flows
    SAFETY_MONITOR -->|/safety_status<br/>SafetyStatus| TELEMETRY_COLLECTOR
    WATCHDOG -->|/system_health<br/>SystemHealth| DIAGNOSTICS
    SENSOR_FUSION -->|/sensor_status<br/>SensorStatus| TELEMETRY_COLLECTOR

    %% Topic Annotations
    subgraph TOPICS["üìã ROS2 TOPIC CATEGORIES"]
        SAFETY_TOPICS[üö® <b>SAFETY CRITICAL TOPICS:</b><br/>&bull; /emergency_stop - Immediate brake activation<br/>&bull; /safety_status - Continuous safety monitoring<br/>&bull; /system_health - Node health validation<br/>&bull; All safety topics use RELIABLE QoS]
        PERCEPTION_TOPICS[üëÅÔ∏è <b>PERCEPTION TOPICS:</b><br/>&bull; /lidar/points - 3D point clouds 20Hz<br/>&bull; /camera/image - RGB images 30Hz<br/>&bull; /radar/scan - Radar detections 25Hz<br/>&bull; /fused_objects - Sensor fusion output 50Hz]
        CONTROL_TOPICS[üéÆ <b>CONTROL TOPICS:</b><br/>&bull; /planned_path - Trajectory waypoints 10Hz<br/>&bull; /control_commands - Actuator commands 100Hz<br/>&bull; /current_pose - Vehicle localization 100Hz<br/>&bull; All control topics use RELIABLE QoS]
        COMM_TOPICS[üì° <b>COMMUNICATION TOPICS:</b><br/>&bull; /fleet_commands - Commands from fleet async<br/>&bull; /vehicle_telemetry - Status to fleet 10Hz<br/>&bull; /v2x_objects - V2X cooperative data 10Hz<br/>&bull; WebSocket and MQTT protocols supported]
    end

    %% Deployment Configuration
    subgraph DEPLOYMENT["üöÄ DEPLOYMENT CONFIGURATION"]
        CONFIG[üìã <b>DEPLOYMENT NOTES:</b><br/>&bull; ROS2 Humble LTS on Ubuntu 22.04<br/>&bull; DDS Middleware: Fast-DDS default<br/>&bull; Real-time kernel for control nodes<br/>&bull; Docker containers for isolation<br/>&bull; systemd services for auto-start<br/>&bull; Resource limits per node<br/>&bull; CPU affinity for critical nodes]
    end

    %% Styling
    classDef safetyCritical fill:#ff4757,stroke:#d63031,stroke-width:3px,color:#fff
    classDef perception fill:#3742fa,stroke:#2f3542,stroke-width:2px,color:#fff
    classDef control fill:#2ed573,stroke:#1dd1a1,stroke-width:2px,color:#fff
    classDef communication fill:#ffa502,stroke:#ff6348,stroke-width:2px,color:#fff
    classDef monitoring fill:#747d8c,stroke:#57606f,stroke-width:2px,color:#fff
    classDef topics fill:#a4b0be,stroke:#747d8c,stroke-width:1px
    classDef deployment fill:#5f27cd,stroke:#341f97,stroke-width:2px,color:#fff

    class SAFETY_MONITOR,EMERGENCY_STOP,WATCHDOG safetyCritical
    class LIDAR,CAMERA,RADAR,SENSOR_FUSION,PERCEPTION_PIPELINE perception
    class LOCALIZATION,PATH_PLANNER,MOTION_CONTROLLER,VEHICLE_INTERFACE control
    class FLEET_GATEWAY,V2X_COMM,TELEMETRY_COLLECTOR communication
    class DIAGNOSTICS,DATA_RECORDER monitoring
    class SAFETY_TOPICS,PERCEPTION_TOPICS,CONTROL_TOPICS,COMM_TOPICS topics
    class CONFIG deployment
