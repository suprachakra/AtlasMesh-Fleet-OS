%%{init: {'flowchart': {'htmlLabels': true}} }%%
flowchart TB

    %% Trust Boundaries
    subgraph TB1["üåê TRUST BOUNDARY: Internet/External"]
        Attacker[üî¥ Malicious Actor<br/>External Threat]
        Operator[üë§ Fleet Operator<br/>Legitimate User]
    end

    subgraph TB2["üè¢ TRUST BOUNDARY: Fleet Management System"]
        Gateway[üö™ API Gateway<br/>Entry Point]
        Auth[üîê Auth Service<br/>Authentication]
        VGW[üåê Vehicle Gateway<br/>Communication Hub]
        CmdDB[(üóÑÔ∏è Command Database<br/>Persistent Storage)]
        Kafka[(üì® Event Bus Kafka<br/>Message Queue)]
    end

    subgraph TB3["üöó TRUST BOUNDARY: Vehicle Network"]
        Agent[ü§ñ Vehicle Agent<br/>Edge Computing]
        Vehicle[üöó Vehicle Systems<br/>Physical Control]
    end

    %% SPOOFING THREATS
    Attacker -.->|S1: Identity Spoofing<br/>Steal operator credentials<br/>Impersonate authorized user| Operator
    Attacker -.->|S2: Vehicle Identity Spoofing<br/>Spoof vehicle certificates<br/>Impersonate legitimate vehicle| Vehicle

    %% TAMPERING THREATS
    Attacker -.->|T1: Command Tampering<br/>Modify vehicle commands in transit<br/>Alter command parameters| Gateway
    Attacker -.->|T2: Event Tampering<br/>Modify audit logs<br/>Alter telemetry data| Kafka

    %% REPUDIATION THREATS
    Operator -.->|R1: Command Repudiation<br/>Deny issuing dangerous commands<br/>Claim commands were unauthorized| CmdDB

    %% INFORMATION DISCLOSURE THREATS
    Attacker -.->|I1: Telemetry Interception<br/>Eavesdrop on vehicle communications<br/>Steal location/operational data| VGW
    Attacker -.->|I2: Credential Disclosure<br/>Steal authentication tokens<br/>Access user credentials| Auth

    %% DENIAL OF SERVICE THREATS
    Attacker -.->|D1: API Flooding<br/>Overwhelm API with requests<br/>Exhaust system resources| Gateway
    Attacker -.->|D2: WebSocket Exhaustion<br/>Flood vehicle connections<br/>Disrupt real-time communication| VGW

    %% ELEVATION OF PRIVILEGE THREATS
    Attacker -.->|E1: Privilege Escalation<br/>Exploit authentication flaws<br/>Gain administrative access| Auth

    %% Normal Data Flows
    Operator -->|Legitimate Commands| Gateway
    Gateway -->|Authenticated Requests| Auth
    Gateway -->|Validated Commands| VGW
    VGW -->|Secure Communication| Agent
    Agent -->|Control Signals| Vehicle
    Vehicle -->|Telemetry Data| Agent
    Agent -->|Status Updates| VGW
    VGW -->|Event Publishing| Kafka
    Gateway -->|Command Storage| CmdDB

    %% MITIGATIONS
    subgraph MITIGATIONS["üõ°Ô∏è SECURITY MITIGATIONS"]
        direction TB
        subgraph SPOOFING_MIT["üîí SPOOFING MITIGATIONS"]
            S_MFA[‚úÖ Multi-factor authentication]
            S_CERT[‚úÖ Certificate-based vehicle identity]
            S_JWT[‚úÖ JWT tokens short TTL]
            S_MTLS[‚úÖ mTLS for all communications]
        end
        subgraph TAMPERING_MIT["üîê TAMPERING MITIGATIONS"]
            T_SIG[‚úÖ Digital signatures on commands]
            T_TLS[‚úÖ TLS encryption for all traffic]
            T_HMAC[‚úÖ HMAC integrity checks]
            T_AUDIT[‚úÖ Immutable audit logs]
        end
        subgraph REPUDIATION_MIT["üìù REPUDIATION MITIGATIONS"]
            R_CRYPTO[‚úÖ Cryptographic command signatures]
            R_LOG[‚úÖ Comprehensive audit logging]
            R_CERT[‚úÖ Non-repudiation certificates]
            R_CHAIN[‚úÖ Blockchain audit trail -future]
        end
        subgraph DISCLOSURE_MIT["üîç INFO DISCLOSURE MITIGATIONS"]
            I_E2E[‚úÖ End-to-end encryption]
            I_DLP[‚úÖ Data classification & DLP]
            I_SEG[‚úÖ Network segmentation]
            I_ZERO[‚úÖ Zero-trust architecture]
        end
        subgraph DOS_MIT["‚ö° DENIAL OF SERVICE MITIGATIONS"]
            D_RATE[‚úÖ Rate limiting & throttling]
            D_DDOS[‚úÖ DDoS protection]
            D_CIRCUIT[‚úÖ Circuit breakers]
            D_PRIORITY[‚úÖ Priority queues for safety commands]
        end
        subgraph ELEVATION_MIT["üîê ELEVATION MITIGATIONS"]
            E_LEAST[‚úÖ Least privilege]
            E_RBAC[‚úÖ RBAC]
            E_AUDIT[‚úÖ Regular security audits]
            E_SCAN[‚úÖ Vulnerability scanning]
        end
    end

    %% HIGH-RISK ATTACK SCENARIOS
%% HIGH-RISK ATTACK SCENARIOS
subgraph SCENARIOS["üö® HIGH-RISK ATTACK SCENARIOS"]
    direction TB
    SCENARIO1["üî¥ <b>SCENARIO 1: Malicious Command Injection</b><br/>&bull; Compromise operator creds (S1)<br/>&bull; Issue fleet-wide stop (T1)<br/><b>MITIGATION:</b> Dual authorization"]
    SCENARIO3["üî¥ <b>SCENARIO 3: Privacy Breach</b><br/>&bull; Intercept telemetry (I1)<br/>&bull; Track locations/PII<br/><b>MITIGATION:</b> E2EE + anonymization"]
    SCENARIO4["üî¥ <b>SCENARIO 4: Service Disruption</b><br/>&bull; Flood vehicle GW (D2)<br/>&bull; Disrupt real-time comms<br/><b>MITIGATION:</b> DDoS + priority queues"]
end


    %% SECURITY CONTROLS MAPPING
    subgraph CONTROLS["üîß SECURITY CONTROLS"]
        direction TB
        AUTH_CONTROLS[üîë AUTHN/AUTHZ:<br/>‚Ä¢ OAuth2 + OIDC<br/>‚Ä¢ JWT RS256<br/>‚Ä¢ MFA<br/>‚Ä¢ RBAC/ABAC]
        COMM_CONTROLS[üì° COMMUNICATION SECURITY:<br/>‚Ä¢ TLS 1.3<br/>‚Ä¢ mTLS S2S<br/>‚Ä¢ WSS for vehicles<br/>‚Ä¢ Cert pinning]
        DATA_CONTROLS[üóÑÔ∏è DATA PROTECTION:<br/>‚Ä¢ AES-256 at rest<br/>‚Ä¢ Field-level PII enc<br/>‚Ä¢ DLP<br/>‚Ä¢ Vault/KMS]
        MONITOR_CONTROLS[üìä MONITORING & DETECTION:<br/>‚Ä¢ SIEM<br/>‚Ä¢ IDS<br/>‚Ä¢ Vehicle anomaly detection<br/>‚Ä¢ Real-time dashboards]
        INCIDENT_CONTROLS[üö® INCIDENT RESPONSE:<br/>‚Ä¢ Automated response<br/>‚Ä¢ Playbooks<br/>‚Ä¢ Escalation<br/>‚Ä¢ Forensic logging]
    end

    %% Styling
    classDef threatHigh fill:#ff4757,stroke:#d63031,stroke-width:3px,color:#fff
    classDef threatMedium fill:#ffa502,stroke:#ff7675,stroke-width:2px,color:#fff
    classDef threatLow fill:#fdcb6e,stroke:#e17055,stroke-width:2px
    classDef mitigation fill:#00b894,stroke:#00a085,stroke-width:2px,color:#fff
    classDef system fill:#74b9ff,stroke:#0984e3,stroke-width:2px,color:#fff
    classDef external fill:#636e72,stroke:#2d3436,stroke-width:2px,color:#fff
    classDef scenario fill:#ff7675,stroke:#d63031,stroke-width:2px,color:#fff
    classDef controls fill:#a29bfe,stroke:#6c5ce7,stroke-width:2px,color:#fff

    class Attacker threatHigh
    class Operator external
    class Gateway,Auth,VGW,Agent,Vehicle system
           direction TB
SCENARIO1["üî¥ <b>SCENARIO 1: Malicious Command Injection</b><br/>&bull; Compromise operator creds (S1)<br/>&bull; Issue fleet-wide stop (T1)<br/><b>MITIGATION:</b> Dual authorization"]
class CmdDB,Kafka system
    class SCENARIO1,SCENARIO2,SCENARIO3,SCENARIO4 scenario
    class AUTH_CONTROLS,COMM_CONTROLS,DATA_CONTROLS,MONITOR_CONTROLS,INCIDENT_CONTROLS controls
