# AtlasMesh Fleet OS - PgBouncer Configuration
# Connection pooling for high-performance database access

[databases]
# Production database
atlasmesh_prod = host=localhost port=5432 dbname=atlasmesh_fleet_os user=fleet_user pool_size=25 reserve_pool=5

# Read replica for analytics
atlasmesh_analytics = host=localhost port=5433 dbname=atlasmesh_fleet_os user=analytics_user pool_size=15 reserve_pool=3

# Development database
atlasmesh_dev = host=localhost port=5432 dbname=atlasmesh_fleet_os_dev user=dev_user pool_size=10 reserve_pool=2

[pgbouncer]
# Connection pooling mode
# - session: server is released back to pool after client disconnects (default)
# - transaction: server is released back to pool after transaction finishes
# - statement: server is released back to pool after query finishes
pool_mode = transaction

# Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Connection limits
max_client_conn = 1000
default_pool_size = 20
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 5

# Server connection limits
max_db_connections = 100
max_user_connections = 100

# Timeouts (in seconds)
server_reset_query = DISCARD ALL
server_reset_query_always = 0
server_check_delay = 30
server_check_query = select 1
server_lifetime = 3600
server_idle_timeout = 600
query_timeout = 0
query_wait_timeout = 120
client_idle_timeout = 0
client_login_timeout = 60
autodb_idle_timeout = 3600

# Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

# Admin interface
admin_users = admin, fleet_admin
stats_users = stats, monitoring

# Performance tuning
server_round_robin = 1
ignore_startup_parameters = extra_float_digits

# SSL configuration (for production)
server_tls_sslmode = prefer
server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
server_tls_key_file = /etc/pgbouncer/server.key
server_tls_cert_file = /etc/pgbouncer/server.crt

client_tls_sslmode = allow
client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
client_tls_key_file = /etc/pgbouncer/client.key
client_tls_cert_file = /etc/pgbouncer/client.crt

# Application-specific settings for AtlasMesh Fleet OS
application_name_add_host = 1

# Disable prepared statements for better pooling
server_reset_query = DISCARD ALL

# Custom pool configurations for different services
[databases]
# Fleet Manager Service - High concurrency
fleet_manager = host=localhost port=5432 dbname=atlasmesh_fleet_os user=fleet_manager_user pool_size=30 reserve_pool=10

# Vehicle Gateway - Real-time telemetry
vehicle_gateway = host=localhost port=5432 dbname=atlasmesh_fleet_os user=vehicle_gateway_user pool_size=40 reserve_pool=15

# Policy Engine - Moderate load
policy_engine = host=localhost port=5432 dbname=atlasmesh_fleet_os user=policy_engine_user pool_size=15 reserve_pool=5

# Analytics - Read-heavy workload
analytics = host=localhost port=5433 dbname=atlasmesh_fleet_os user=analytics_user pool_size=20 reserve_pool=5

# Reporting - Batch processing
reporting = host=localhost port=5433 dbname=atlasmesh_fleet_os user=reporting_user pool_size=10 reserve_pool=2

# Maintenance - Low priority
maintenance = host=localhost port=5432 dbname=atlasmesh_fleet_os user=maintenance_user pool_size=5 reserve_pool=1
