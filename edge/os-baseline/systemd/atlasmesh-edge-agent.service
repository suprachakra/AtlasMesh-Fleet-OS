[Unit]
Description=AtlasMesh Edge Agent
Documentation=https://docs.atlasmesh.com/edge-agent
After=network-online.target containerd.service
Wants=network-online.target
Requires=containerd.service

[Service]
Type=notify
ExecStart=/usr/local/bin/atlasmesh-edge-agent
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
Restart=always
RestartSec=5
TimeoutStartSec=60
TimeoutStopSec=30

# Security settings
User=atlasmesh
Group=atlasmesh
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
PrivateTmp=true
PrivateDevices=false
ProtectHostname=true
ProtectClock=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectKernelLogs=true
ProtectControlGroups=true
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6 AF_NETLINK
RestrictNamespaces=true
LockPersonality=true
MemoryDenyWriteExecute=true
RestrictRealtime=true
RestrictSUIDSGID=true
RemoveIPC=true

# Capabilities
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SYS_TIME
AmbientCapabilities=CAP_NET_BIND_SERVICE CAP_SYS_TIME

# File system access
ReadWritePaths=/var/lib/atlasmesh /var/log/atlasmesh
ReadOnlyPaths=/etc/atlasmesh
BindReadOnlyPaths=/etc/ssl/atlasmesh

# Environment
Environment=ATLASMESH_HOME=/var/lib/atlasmesh
Environment=ATLASMESH_CONFIG=/etc/atlasmesh
Environment=ATLASMESH_LOG_LEVEL=info
EnvironmentFile=-/etc/atlasmesh/edge-agent.env

# Resource limits
LimitNOFILE=65536
LimitNPROC=4096
MemoryMax=2G
CPUQuota=200%

# Watchdog
WatchdogSec=30

[Install]
WantedBy=multi-user.target
